<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ads Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body { margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#111; }
    .wrap { display:flex; min-height:100vh; }
    .sidebar {
      width: 260px; background:#0f172a; color:#e5e7eb; padding:16px; position:sticky; top:0; height:100vh;
    }
    .brand { font-weight:700; margin-bottom:16px; font-size:18px; letter-spacing:.3px; }
    .h1 { text-transform:uppercase; font-size:12px; color:#94a3b8; margin:20px 0 8px; }
    .nav a {
      display:block; padding:10px 12px; color:#e5e7eb; text-decoration:none; border-radius:8px; margin-bottom:6px;
    }
    .nav a.active, .nav a:hover { background:#1f2937; }
    .main { flex:1; padding:20px; background:#f8fafc; }
    .toolbar { display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    input, button, select {
      padding:8px 10px; border:1px solid #cbd5e1; border-radius:8px; background:#fff;
    }
    button { cursor:pointer; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; }
    th, td { padding:10px; border-bottom:1px solid #e5e7eb; text-align:left; font-size:13px; }
    th { background:#f1f5f9; position:sticky; top:0; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin-bottom:16px; }
    .muted { color:#475569; font-size:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <aside class="sidebar">
    <div class="brand">Your Ads Console</div>
    <div class="h1">Advertising</div>
    <div class="nav">
      <a href="#keywords" id="nav-keywords">Keyword Data</a>
      <a href="#searchterms" id="nav-searchterms">Search Terms</a>
    </div>
  </aside>

  <main class="main">
    <div class="toolbar">
      <label>Start: <input type="date" id="start"></label>
      <label>End: <input type="date" id="end"></label>
      <button id="loadBtn">Load</button>
      <span class="muted" id="status"></span>
    </div>
    <div class="card">
      <table id="dataTable">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>
</div>

<script>
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  const statusEl = document.getElementById('status');
  const navKeywords = document.getElementById('nav-keywords');
  const navSearch = document.getElementById('nav-searchterms');
  const startEl = document.getElementById('start');
  const endEl = document.getElementById('end');

  // default to the last 2 days
  const today = new Date();
  const yday = new Date(today.getTime() - 86400000);
  const d2 = new Date(today.getTime() - 2*86400000);
  startEl.value = d2.toISOString().slice(0,10);
  endEl.value = yday.toISOString().slice(0,10);

  function setActive(hash) {
    navKeywords.classList.toggle('active', hash === '#keywords');
    navSearch.classList.toggle('active', hash === '#searchterms');
  }

  function currentView() {
    return (location.hash === '#searchterms') ? 'searchterms' : 'keywords';
  }

  function columnsFor(view) {
    if (view === 'searchterms') {
      return [
        'date','campaign_name','ad_group_name','search_term',
        'keyword_text','match_type','impressions','clicks','cost','sales','orders','cpc','ctr','acos','roas'
      ];
    }
    // keywords
    return [
      'date','campaign_name','ad_group_name','keyword_text',
      'match_type','impressions','clicks','cost','sales','orders','cpc','ctr','acos','roas'
    ];
  }

  async function loadData() {
    const s = startEl.value;
    const e = endEl.value;
    const view = currentView();
    setActive('#' + view);

    let url;
    if (view === 'searchterms') {
      url = `/api/sp/searchterms_range?start=${s}&end=${e}&limit=1000`;
    } else {
      url = `/api/sp/keywords_range?start=${s}&end=${e}&limit=1000`;
    }

    statusEl.textContent = 'Loading...';
    tbody.innerHTML = '';
    try {
      const res = await fetch(url);
      const data = await res.json();

      const cols = columnsFor(view);
      thead.innerHTML = '<tr>' + cols.map(c => `<th>${c.replace(/_/g,' ')}</th>`).join('') + '</tr>';

      const fmt = n => (typeof n === 'number' ? n.toLocaleString() : (n ?? ''));

      // data for keywords_range returns an array of objects with nested metrics in your earlier endpoint;
      // searchterms_range returns flat dicts (we return dict(r)).
      for (const row of data) {
        const flat = row.metrics ? {
          date: row.pulled_at, // not ideal; keywords_range returns date inside DB row; you can expose it similarly
          campaign_name: row.campaign_name,
          ad_group_name: row.ad_group_name,
          keyword_text: row.keyword_text,
          match_type: row.match_type,
          impressions: row.metrics.impressions,
          clicks: row.metrics.clicks,
          cost: row.metrics.spend,
          sales: row.metrics.sales,
          orders: row.metrics.orders,
          cpc: row.metrics.cpc,
          ctr: row.metrics.ctr,
          acos: row.metrics.acos,
          roas: row.metrics.roas,
          search_term: row.search_term || ''
        } : row;

        const tds = columnsFor(view).map(k => `<td>${fmt(flat[k])}</td>`).join('');
        tbody.insertAdjacentHTML('beforeend', `<tr>${tds}</tr>`);
      }

      statusEl.textContent = `Rows: ${data.length}`;
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Error loading data';
    }
  }

  document.getElementById('loadBtn').addEventListener('click', loadData);
  window.addEventListener('hashchange', loadData);

  // set default view
  if (!location.hash) location.hash = '#keywords';
  setActive(location.hash);
  loadData();
</script>
</body>
</html>
