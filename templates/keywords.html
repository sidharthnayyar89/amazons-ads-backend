<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ads Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:#0e1117; color:#fff; padding:20px; }
    .sidebar h2 { margin:0 0 16px; font-size:18px; color:#9ccaff; }
    .nav .section { margin-bottom:18px; }
    .nav .section h3 { font-size:12px; color:#98a6c3; margin:10px 0 6px; text-transform:uppercase; letter-spacing:.06em; }
    .nav a { display:block; padding:8px 10px; color:#dfe6f3; text-decoration:none; border-radius:6px; }
    .nav a:hover { background:#1b2230; }
    .nav a.active { background:#2a364a; color:#fff; }
    .content { flex:1; padding:20px 24px; background:#f6f8fb; }
    .controls { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    input, button { padding:8px 10px; border:1px solid #ccd6e5; border-radius:6px; background:#fff; }
    button { cursor:pointer; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
    th, td { padding:8px 10px; border-bottom:1px solid #eef2f7; font-size:13px; text-align:left; }
    th { background:#f2f6fb; color:#4a5a73; position:sticky; top:0; }
    .muted { color:#6b7a90; }
    .page-title { font-size:18px; font-weight:600; margin:6px 0 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="sidebar">
      <h2>Advertising</h2>
      <div class="nav">
        <div class="section">
          <h3>Pages</h3>
          <a href="/ads/keywords" id="nav-keywords">Keyword Data</a>
          <a href="/ads/search-terms" id="nav-search">Search Terms</a>
        </div>
      </div>
    </aside>

    <main class="content">
      <div class="controls">
        <label>Start <input id="start" type="date"/></label>
        <label>End <input id="end" type="date"/></label>
        <button onclick="loadPage()">Load</button>
        <span id="status" class="muted"></span>
      </div>

      <div class="page-title" id="page-title"></div>

      <!-- Keyword page -->
      <div id="page-keywords" style="display:none;">
        <table id="tbl-keywords">
          <thead>
            <tr>
              <th>Date</th><th>Campaign</th><th>Ad Group</th><th>Keyword</th><th>Match</th>
              <th>Impr</th><th>Clicks</th><th>Cost</th><th>Sales</th><th>Orders</th>
              <th>CPC</th><th>CTR</th><th>ACOS</th><th>ROAS</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Search Terms page -->
      <div id="page-search" style="display:none;">
        <table id="tbl-search">
          <thead>
            <tr>
              <th>Date</th><th>Campaign</th><th>Ad Group</th><th>Search Term</th><th>Keyword</th><th>Match</th>
              <th>Impr</th><th>Clicks</th><th>Cost</th><th>Sales</th><th>Orders</th>
              <th>CPC</th><th>CTR</th><th>ACOS</th><th>ROAS</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>

<script>
function iso(d){ return d.toISOString().slice(0,10); }
function setDefaults() {
  const end = new Date();
  const start = new Date(); start.setDate(end.getDate()-1);
  document.getElementById('start').value = iso(start);
  document.getElementById('end').value = iso(end);
}
function fmt(n){ return (typeof n==='number') ? n.toLocaleString(undefined,{maximumFractionDigits:2}) : n; }

function activateNav(path) {
  document.getElementById('nav-keywords').classList.toggle('active', path==='/ads/keywords');
  document.getElementById('nav-search').classList.toggle('active', path==='/ads/search-terms');
}

function showPage(path){
  const title = document.getElementById('page-title');
  const kw = document.getElementById('page-keywords');
  const st = document.getElementById('page-search');

  if (path === '/ads/search-terms') {
    title.textContent = 'Advertising / Search Terms';
    kw.style.display = 'none';
    st.style.display = 'block';
  } else {
    title.textContent = 'Advertising / Keyword Data';
    kw.style.display = 'block';
    st.style.display = 'none';
  }
  activateNav(path);
}

async function loadPage(){
  const s = document.getElementById('start').value;
  const e = document.getElementById('end').value;
  const status = document.getElementById('status');
  const path = window.location.pathname;

  try{
    status.textContent = 'Loading...';

    if (path === '/ads/search-terms') {
      const r = await fetch(`/api/sp/st_range?start=${s}&end=${e}&limit=1000`);
      const rows = await r.json();
      const tb = document.querySelector('#tbl-search tbody');
      tb.innerHTML = '';
      rows.forEach(x=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.date}</td>
          <td>${x.campaign_name}</td>
          <td>${x.ad_group_name}</td>
          <td>${x.search_term}</td>
          <td>${x.keyword_text ?? ''}</td>
          <td>${x.match_type}</td>
          <td>${fmt(x.impressions)}</td>
          <td>${fmt(x.clicks)}</td>
          <td>${fmt(x.cost)}</td>
          <td>${fmt(x.attributed_sales_14d)}</td>
          <td>${fmt(x.attributed_conversions_14d)}</td>
          <td>${fmt(x.cpc)}</td>
          <td>${fmt(x.ctr)}</td>
          <td>${fmt(x.acos)}</td>
          <td>${fmt(x.roas)}</td>
        `;
        tb.appendChild(tr);
      });
    } else {
      const r = await fetch(`/api/sp/keywords_range?start=${s}&end=${e}&limit=1000`);
      const rows = await r.json();
      const tb = document.querySelector('#tbl-keywords tbody');
      tb.innerHTML = '';
      rows.forEach(x=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.pulled_at || x.date || ''}</td>
          <td>${x.campaign_name}</td>
          <td>${x.ad_group_name}</td>
          <td>${x.keyword_text}</td>
          <td>${x.match_type}</td>
          <td>${fmt(x.metrics?.impressions ?? x.impressions)}</td>
          <td>${fmt(x.metrics?.clicks ?? x.clicks)}</td>
          <td>${fmt(x.metrics?.spend ?? x.cost)}</td>
          <td>${fmt(x.metrics?.sales ?? x.attributed_sales_14d)}</td>
          <td>${fmt(x.metrics?.orders ?? x.attributed_conversions_14d)}</td>
          <td>${fmt(x.metrics?.cpc ?? x.cpc)}</td>
          <td>${fmt(x.metrics?.ctr ?? x.ctr)}</td>
          <td>${fmt(x.metrics?.acos ?? x.acos)}</td>
          <td>${fmt(x.metrics?.roas ?? x.roas)}</td>
        `;
        tb.appendChild(tr);
      });
    }

    status.textContent = '';
  }catch(err){
    console.error(err);
    status.textContent = 'Error loading.';
  }
}

(function boot(){
  // Redirect "/" to the default page
  if (window.location.pathname === '/') {
    window.location.replace('/ads/keywords');
    return;
  }
  setDefaults();
  showPage(window.location.pathname);
  loadPage();
})();
</script>
</body>
</html>
