<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SP Keywords Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
    h1 { margin: 0 0 12px; }
    .controls { display: flex; gap: 12px; align-items: end; flex-wrap: wrap; margin-bottom: 12px; }
    label { display:block; font-size:12px; color:#444; margin-bottom:4px; }
    input, select, button { padding: 8px; font-size: 14px; }
    button { cursor: pointer; }
    .row { display: flex; gap: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px 6px; text-align: left; font-size: 13px; }
    th { position: sticky; top: 0; background: #fafafa; z-index: 1; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:12px; }
    .muted { color:#777; font-size:12px; }
    .right { margin-left:auto; }
    .metrics { font-variant-numeric: tabular-nums; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body>
  <h1>Sponsored Products â€” Keywords</h1>

  <div class="controls">
    <div>
      <label for="start">Start date</label>
      <input id="start" type="date" />
    </div>
    <div>
      <label for="end">End date</label>
      <input id="end" type="date" />
    </div>
    <div>
      <label for="limit">Rows per page</label>
      <select id="limit">
        <option>50</option>
        <option selected>100</option>
        <option>250</option>
        <option>500</option>
      </select>
    </div>
    <div>
      <button id="apply">Apply</button>
    </div>
    <div class="right muted" id="status"></div>
  </div>

  <div class="pagination">
    <button id="prev">Prev</button>
    <div class="muted">Page <span id="pageNum">1</span></div>
    <button id="next">Next</button>
    <button id="download">Download CSV</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th class="nowrap">Date</th>
        <th>Campaign</th>
        <th>Ad Group</th>
        <th>Keyword</th>
        <th>Match</th>
        <th class="metrics">Impr</th>
        <th class="metrics">Clicks</th>
        <th class="metrics">Spend</th>
        <th class="metrics">Sales</th>
        <th class="metrics">Orders</th>
        <th class="metrics">CPC</th>
        <th class="metrics">CTR</th>
        <th class="metrics">ACOS</th>
        <th class="metrics">ROAS</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_BASE = location.origin;
    const qs = new URLSearchParams(location.search);
    const startEl = document.getElementById('start');
    const endEl   = document.getElementById('end');
    const limitEl = document.getElementById('limit');
    const applyBtn= document.getElementById('apply');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const pageNum = document.getElementById('pageNum');
    const statusEl= document.getElementById('status');
    const tbody   = document.querySelector('#tbl tbody');
    const dlBtn   = document.getElementById('download');

    // defaults: last 2 days
    function yyyy_mm_dd(d){
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${m}-${day}`;
    }
    const today = new Date();
    const y = new Date(today); y.setDate(y.getDate()-1);
    const y2 = new Date(today); y2.setDate(y2.getDate()-2);

    startEl.value = qs.get('start') || yyyy_mm_dd(y2);
    endEl.value   = qs.get('end')   || yyyy_mm_dd(y);
    limitEl.value = qs.get('limit') || '100';

    let page = 1;
    let lastBatch = [];

    async function load(){
      const start = startEl.value;
      const end   = endEl.value;
      const limit = parseInt(limitEl.value,10);
      const offset= (page-1) * limit;

      const url = `${API_BASE}/api/sp/keywords_range?start=${start}&end=${end}&limit=${limit}&offset=${offset}`;
      statusEl.textContent = 'Loading...';
      const t0 = performance.now();
      const res = await fetch(url);
      const data = await res.json();
      lastBatch = Array.isArray(data) ? data : [];
      render(lastBatch);
      const ms = Math.round(performance.now()-t0);
      statusEl.textContent = `Loaded ${lastBatch.length} rows in ${ms} ms`;
      pageNum.textContent = String(page);
    }

    function render(rows){
      tbody.innerHTML = '';
      for (const r of rows){
        const tr = document.createElement('tr');
        const m = r.metrics || {};
        tr.innerHTML = `
          <td class="nowrap">${(r.pulled_at || '')}</td>
          <td>${r.campaign_name || ''}</td>
          <td>${r.ad_group_name || ''}</td>
          <td>${r.keyword_text || ''}</td>
          <td>${r.match_type || ''}</td>
          <td class="metrics">${m.impressions ?? ''}</td>
          <td class="metrics">${m.clicks ?? ''}</td>
          <td class="metrics">${m.spend ?? ''}</td>
          <td class="metrics">${m.sales ?? ''}</td>
          <td class="metrics">${m.orders ?? ''}</td>
          <td class="metrics">${m.cpc ?? ''}</td>
          <td class="metrics">${m.ctr ?? ''}</td>
          <td class="metrics">${m.acos ?? ''}</td>
          <td class="metrics">${m.roas ?? ''}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function toCSV(rows){
      const header = [
        'pulled_at','campaign_name','ad_group_name','keyword_text','match_type',
        'impressions','clicks','spend','sales','orders','cpc','ctr','acos','roas'
      ];
      const lines = [header.join(',')];
      for(const r of rows){
        const m = r.metrics || {};
        const vals = [
          r.pulled_at, r.campaign_name, r.ad_group_name, r.keyword_text, r.match_type,
          m.impressions, m.clicks, m.spend, m.sales, m.orders, m.cpc, m.ctr, m.acos, m.roas
        ].map(v => (v==null ? '' : String(v).replaceAll('"','""')));
        lines.push(vals.map(v => `"${v}"`).join(','));
      }
      return lines.join('\n');
    }

    applyBtn.addEventListener('click', () => { page = 1; load(); });
    prevBtn.addEventListener('click', () => { if (page>1){ page--; load(); } });
    nextBtn.addEventListener('click', () => { if (lastBatch.length >= parseInt(limitEl.value,10)){ page++; load(); }});
    dlBtn.addEventListener('click', () => {
      const csv = toCSV(lastBatch);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sp_keywords_page${page}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    load();
  </script>
</body>
</html>
